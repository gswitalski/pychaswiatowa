# Supabase Angular Initialization - PychaŚwiatowa

Ten dokument zawiera przewodnik do utworzenia struktury plików niezbędnej do integracji Supabase z projektem Angular dla aplikacji PychaŚwiatowa (cyfrowa książka kucharska).

## Wymagania wstępne

- Projekt powinien używać Angular 21 i TypeScript 5
- Zainstaluj pakiet `@supabase/supabase-js`
- Upewnij się, że plik `/supabase/config.toml` istnieje
- Upewnij się, że plik `/shared/types/database.types.ts` istnieje i zawiera poprawne definicje typów dla bazy danych

**WAŻNE:** Sprawdź wymagania wstępne przed wykonaniem poniższych kroków. Jeśli nie są spełnione, zatrzymaj się i zapytaj użytkownika o rozwiązanie.

## Struktura plików i konfiguracja

### 1. Konfiguracja środowisk (Environments)

Utwórz katalog `/src/environments/` oraz pliki konfiguracyjne:

**Plik `/src/environments/environment.ts`:**

```ts
export const environment = {
  production: false,
  supabase: {
    url: 'http://127.0.0.1:54321',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
  }
};
```

**Plik `/src/environments/environment.development.ts`:**

```ts
export const environment = {
  production: false,
  supabase: {
    url: 'http://127.0.0.1:54321',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
  }
};
```

**Plik `/src/environments/environment.production.ts`:**

```ts
export const environment = {
  production: true,
  supabase: {
    url: 'YOUR_PRODUCTION_SUPABASE_URL',
    anonKey: 'YOUR_PRODUCTION_SUPABASE_ANON_KEY'
  }
};
```

Te pliki zawierają konfigurację URL i klucza anonimowego dla Supabase. Wartości dla środowiska lokalnego (development) to standardowe wartości z lokalnej instancji Supabase. W środowisku produkcyjnym należy zastąpić je rzeczywistymi wartościami.

### 2. Inicjalizacja klienta Supabase

Utwórz katalog `/src/app/core/services/` oraz plik serwisu:

**Plik `/src/app/core/services/supabase.service.ts`:**

```ts
import { Injectable } from '@angular/core';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { environment } from '../../../environments/environment';
import type { Database } from '../../../../shared/types/database.types';

@Injectable({
    providedIn: 'root'
})
export class SupabaseService {
    private supabase: SupabaseClient<Database>;

    constructor() {
        this.supabase = createClient<Database>(
            environment.supabase.url,
            environment.supabase.anonKey
        );
    }

    get client(): SupabaseClient<Database> {
        return this.supabase;
    }

    get auth() {
        return this.supabase.auth;
    }

    get from() {
        return this.supabase.from.bind(this.supabase);
    }

    get storage() {
        return this.supabase.storage;
    }
}
```

Ten serwis inicjalizuje klienta Supabase i udostępnia go w całej aplikacji poprzez system Dependency Injection w Angular. Serwis używa `providedIn: 'root'`, co sprawia, że jest singletonem dostępnym globalnie. Dodano również dostęp do `storage` dla obsługi zdjęć przepisów.

### 3. Konfiguracja Angular.json

Upewnij się, że w pliku `angular.json` skonfigurowano wymianę plików środowiskowych:

```json
"configurations": {
  "production": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.production.ts"
      }
    ],
    ...
  },
  "development": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.development.ts"
      }
    ]
  }
}
```

### 4. Bezpieczeństwo - `.gitignore` i plik template

**WAŻNE:** Plik produkcyjny zawiera wrażliwe dane i NIE POWINIEN być commitowany do repozytorium!

#### 4.1. Zaktualizuj `.gitignore`

Dodaj do pliku `.gitignore` ignorowanie pliku produkcyjnego:

```gitignore
# Environment files
.env
.env.*
!.env.example

# Angular production environment (zawiera wrażliwe klucze produkcyjne)
src/environments/environment.production.ts
```

#### 4.2. Utwórz plik template

Utwórz plik `/src/environments/environment.production.template.ts`:

```ts
// Template dla environment.production.ts
//
// INSTRUKCJA:
// 1. Skopiuj ten plik do: environment.production.ts
// 2. Uzupełnij prawdziwe wartości z Twojego projektu Supabase
// 3. NIE commituj pliku environment.production.ts do repozytorium!
//
// Gdzie znaleźć wartości:
// - Zaloguj się do dashboard Supabase: https://supabase.com/dashboard
// - Wybierz swój projekt
// - Przejdź do: Settings > API
// - Skopiuj "Project URL" jako 'url'
// - Skopiuj "anon/public" key jako 'anonKey'

export const environment = {
    production: true,
    supabase: {
        url: 'YOUR_PRODUCTION_SUPABASE_URL',      // np. https://xxxxxxxxxxxxx.supabase.co
        anonKey: 'YOUR_PRODUCTION_SUPABASE_ANON_KEY'  // klucz anon/public z dashboard
    }
};
```

#### 4.3. Dokumentacja dla zespołu

Opcjonalnie utwórz plik `/src/environments/README.md` z instrukcjami dla zespołu deweloperskiego, który wyjaśnia:
- Strukturę plików środowiskowych
- Jak działa wymiana plików w Angular
- Setup dla nowych deweloperów
- Zasady bezpieczeństwa
- Integrację z CI/CD

#### 4.4. Struktura finalna katalogu `/src/environments/`

```
src/environments/
├── environment.ts                     ✅ Commitowany (domyślny - lokalna instancja)
├── environment.development.ts         ✅ Commitowany (dev - lokalna instancja)
├── environment.production.ts          ❌ ZIGNOROWANY w Git (produkcja - wrażliwe dane)
├── environment.production.template.ts ✅ Commitowany (template bez wrażliwych danych)
└── README.md                          ✅ Commitowany (opcjonalna dokumentacja)
```

**Uwagi dotyczące bezpieczeństwa:**
- Pliki `environment.ts` i `environment.development.ts` używają lokalnej instancji Supabase (127.0.0.1:54321) ze standardowym kluczem demo - bezpieczne do commitowania
- Plik `environment.production.ts` zawiera rzeczywiste klucze produkcyjne - MUSI być zignorowany w Git
- Plik `environment.production.template.ts` służy jako szablon dla zespołu - bezpieczny do commitowania
- W CI/CD (GitHub Actions) plik produkcyjny powinien być tworzony dynamicznie z GitHub Secrets

### 5. Przykład użycia

**W komponencie:**

```ts
import { Component, inject, OnInit } from '@angular/core';
import { SupabaseService } from './core/services/supabase.service';

@Component({
    selector: 'app-example',
    standalone: true,
    template: `...`
})
export class ExampleComponent implements OnInit {
    private supabase = inject(SupabaseService);

    async ngOnInit() {
        // Przykład: pobieranie przepisów użytkownika
        const { data: recipes, error } = await this.supabase
            .from('recipes')
            .select('*, categories(name), recipe_tags(tags(name))')
            .is('deleted_at', null)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Błąd pobierania przepisów:', error);
            return;
        }

        console.log('Przepisy:', recipes);
    }

    // Przykład: autentykacja
    async signIn(email: string, password: string) {
        const { data, error } = await this.supabase.auth.signInWithPassword({
            email,
            password
        });

        return { data, error };
    }

    // Przykład: dodawanie nowego przepisu
    async addRecipe(recipe: {
        name: string;
        description?: string;
        category_id?: number;
        ingredients: any;
        steps: any;
    }) {
        const { data, error } = await this.supabase
            .from('recipes')
            .insert([recipe])
            .select()
            .single();

        return { data, error };
    }

    // Przykład: przesyłanie zdjęcia przepisu
    async uploadRecipeImage(file: File, recipeId: number) {
        const fileExt = file.name.split('.').pop();
        const fileName = `${recipeId}-${Date.now()}.${fileExt}`;
        const filePath = `recipe-images/${fileName}`;

        const { data, error } = await this.supabase.storage
            .from('recipes')
            .upload(filePath, file);

        if (error) {
            console.error('Błąd przesyłania zdjęcia:', error);
            return { data: null, error };
        }

        // Aktualizacja ścieżki zdjęcia w przepisie
        const { error: updateError } = await this.supabase
            .from('recipes')
            .update({ image_path: filePath })
            .eq('id', recipeId);

        return { data: filePath, error: updateError };
    }
}
```

### 6. Opcjonalnie: Guard dla chronionych tras

Możesz stworzyć guard do ochrony tras wymagających autentykacji:

**Plik `/src/app/core/guards/auth.guard.ts`:**

```ts
import { inject } from '@angular/core';
import { Router } from '@angular/router';
import { SupabaseService } from '../services/supabase.service';

export const authGuard = async () => {
  const supabase = inject(SupabaseService);
  const router = inject(Router);

  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    router.navigate(['/login']);
    return false;
  }

  return true;
};
```

**Użycie w routingu:**

```ts
import { Routes } from '@angular/router';
import { authGuard } from './core/guards/auth.guard';

export const routes: Routes = [
  {
    path: 'dashboard',
    canActivate: [authGuard],
    loadComponent: () => import('./pages/dashboard/dashboard.component')
  }
];
```

## Notatki

### Architektura i praktyki Angular
- Serwis `SupabaseService` jest singletonem dostępnym w całej aplikacji
- Używaj funkcji `inject()` zamiast konstruktora dla Dependency Injection (zgodnie z najnowszymi praktykami Angular)
- Wszystkie operacje na bazie danych są w pełni typowane dzięki importowi `Database` z `database.types.ts`
- Klient Supabase jest dostępny przez właściwość `client` w serwisie, ale możesz też używać skrótów `auth`, `from` i `storage` dla wygody
- Guard `authGuard` jest funkcyjnym guardem (zgodnie z najnowszymi praktykami Angular 20)

### Zmienne środowiskowe i bezpieczeństwo
- **Angular NIE używa plików `.env`** - zamiast tego używa plików `environment.ts`, które są kompilowane do bundle'a podczas budowania
- Pliki środowiskowe dla lokalnej instancji (`environment.ts`, `environment.development.ts`) są bezpieczne do commitowania
- Plik `environment.production.ts` MUSI być zignorowany w `.gitignore` - zawiera wrażliwe klucze produkcyjne
- Użyj pliku `environment.production.template.ts` jako szablonu dla zespołu deweloperskiego
- W CI/CD twórz plik produkcyjny dynamicznie z GitHub Secrets (nigdy nie commituj kluczy produkcyjnych!)

### Supabase i baza danych
- Pamiętaj o filtrowaniu przepisów z `deleted_at IS NULL` dla obsługi soft delete
- Zdjęcia przepisów są przechowywane w Supabase Storage w buckecie `recipes`
- Używaj relacji w zapytaniach (np. `select('*, categories(name)')`) aby uniknąć problemu N+1
- Row Level Security (RLS) zapewnia, że użytkownicy mają dostęp tylko do swoich danych
- Klucz `anonKey` jest techniczne "publiczny" (używany w przeglądarce), ale jest zabezpieczony przez RLS w bazie danych
