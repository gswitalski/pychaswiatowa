###
# Test requests for GET /recipes/{id}/normalized-ingredients endpoint
# Usage: Use REST Client extension in VS Code or similar HTTP client
###

@baseUrl = http://localhost:54331/functions/v1/recipes
# For deployed function use:
# @baseUrl = https://YOUR_PROJECT_REF.supabase.co/functions/v1/recipes

# Authentication token - replace with valid JWT from your local Supabase instance
# To get token: Log in as test@pychaswiatowa.pl (password: 554G5rjnbdAanGR) and copy access_token
@authToken = YOUR_JWT_TOKEN_HERE

# Test recipe ID - replace with an existing recipe ID from your local database
@testRecipeId = 1

###
# Test 1: Get normalized ingredients - Status READY with items
# Prerequisites: Recipe with ID @testRecipeId exists and has normalized ingredients in READY state
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (200):
# {
#     "recipe_id": 1,
#     "status": "READY",
#     "updated_at": "2024-01-18T10:30:00Z",
#     "items": [
#         {
#             "amount": 500,
#             "unit": "g",
#             "name": "mąka"
#         },
#         {
#             "amount": 250,
#             "unit": "ml",
#             "name": "mleko"
#         },
#         {
#             "amount": 2,
#             "unit": "szt.",
#             "name": "jajko"
#         },
#         {
#             "amount": null,
#             "unit": null,
#             "name": "sól do smaku"
#         }
#     ]
# }

###
# Test 2: Get normalized ingredients - Status PENDING (empty items)
# Prerequisites: Recipe exists but normalization hasn't completed yet
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (200):
# {
#     "recipe_id": 1,
#     "status": "PENDING",
#     "updated_at": null,
#     "items": []
# }

###
# Test 3: Get normalized ingredients - Status FAILED (empty items)
# Prerequisites: Recipe exists but normalization failed
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (200):
# {
#     "recipe_id": 1,
#     "status": "FAILED",
#     "updated_at": "2024-01-18T10:30:00Z",
#     "items": []
# }

###
# Test 4: Unauthorized - Missing JWT token
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients

# Expected response (401):
# {
#     "code": "UNAUTHORIZED",
#     "message": "Missing or invalid authentication token"
# }

###
# Test 5: Unauthorized - Invalid JWT token
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer invalid_token_12345

# Expected response (401):
# {
#     "code": "UNAUTHORIZED",
#     "message": "Invalid JWT token"
# }

###
# Test 6: Bad Request - Invalid recipe ID (not a number)
GET {{baseUrl}}/abc/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: 'abc'. ID must be a positive integer."
# }

###
# Test 7: Bad Request - Invalid recipe ID (zero)
GET {{baseUrl}}/0/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: '0'. ID must be a positive integer."
# }

###
# Test 8: Bad Request - Invalid recipe ID (negative)
GET {{baseUrl}}/-5/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: '-5'. ID must be a positive integer."
# }

###
# Test 9: Not Found - Recipe doesn't exist
GET {{baseUrl}}/999999/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID 999999 not found"
# }

###
# Test 10: Not Found - Recipe is soft-deleted
# Prerequisites: Recipe with ID exists but is soft-deleted (deleted_at IS NOT NULL)
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID X not found"
# }

###
# Test 11: Not Found - Access denied (different user's recipe)
# Prerequisites: Recipe exists but belongs to another user
# Use token from different user account
@otherUserToken = OTHER_USER_JWT_TOKEN_HERE
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{otherUserToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID X not found"
# }
# Note: Returns 404 (not 403) to prevent information leak about recipe existence

###
# Test 12: Edge case - Recipe with empty normalized ingredients array (status READY)
# Prerequisites: Recipe with normalized_ingredients_status='READY' but items=[] in database
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (200):
# {
#     "recipe_id": 1,
#     "status": "READY",
#     "updated_at": "2024-01-18T10:30:00Z",
#     "items": []
# }

###
# Test 13: Real-world example - Complex recipe with multiple units
# Prerequisites: Recipe with various ingredient types
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected response (200):
# {
#     "recipe_id": 1,
#     "status": "READY",
#     "updated_at": "2024-01-18T10:30:00Z",
#     "items": [
#         { "amount": 1000, "unit": "g", "name": "mąka" },
#         { "amount": 500, "unit": "ml", "name": "woda" },
#         { "amount": 3, "unit": "szt.", "name": "jajko" },
#         { "amount": 2, "unit": "ząbek", "name": "czosnek" },
#         { "amount": 1, "unit": "łyżeczka", "name": "sól" },
#         { "amount": 2, "unit": "łyżka", "name": "olej" },
#         { "amount": 1, "unit": "szczypta", "name": "pieprz" },
#         { "amount": 1, "unit": "pęczek", "name": "koperek" },
#         { "amount": null, "unit": null, "name": "przyprawa do smaku" }
#     ]
# }

###
# ============================================================================
# POST /recipes/{id}/normalized-ingredients/refresh - Enqueue Normalization Refresh
# ============================================================================

###
# Test 14: Refresh normalization - Success (202 Accepted)
# Prerequisites: Recipe with ID @testRecipeId exists and user owns it
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (202 Accepted):
# {
#     "recipe_id": 1,
#     "status": "PENDING"
# }
# Note: Status is always PENDING after refresh, regardless of previous state

###
# Test 15: Refresh normalization - Idempotency test (multiple calls)
# Prerequisites: Recipe with ID @testRecipeId exists
# Call this multiple times in a row - should always return 202 with PENDING status
# Job should be deduplicated in the queue (no duplicates in normalized_ingredients_jobs table)
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (202 Accepted):
# {
#     "recipe_id": 1,
#     "status": "PENDING"
# }
# Note: Check database - only one job should exist for this recipe_id

###
# Test 16: Refresh normalization - Unauthorized (Missing JWT token)
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh

# Expected response (401):
# {
#     "code": "UNAUTHORIZED",
#     "message": "Missing or invalid authentication token"
# }

###
# Test 17: Refresh normalization - Unauthorized (Invalid JWT token)
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer invalid_token_12345

# Expected response (401):
# {
#     "code": "UNAUTHORIZED",
#     "message": "Invalid JWT token"
# }

###
# Test 18: Refresh normalization - Bad Request (Invalid recipe ID - not a number)
POST {{baseUrl}}/abc/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: 'abc'. ID must be a positive integer."
# }

###
# Test 19: Refresh normalization - Bad Request (Invalid recipe ID - zero)
POST {{baseUrl}}/0/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: '0'. ID must be a positive integer."
# }

###
# Test 20: Refresh normalization - Bad Request (Invalid recipe ID - negative)
POST {{baseUrl}}/-5/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (400):
# {
#     "code": "VALIDATION_ERROR",
#     "message": "Invalid recipe ID: '-5'. ID must be a positive integer."
# }

###
# Test 21: Refresh normalization - Not Found (Recipe doesn't exist)
POST {{baseUrl}}/999999/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID 999999 not found"
# }

###
# Test 22: Refresh normalization - Not Found (Recipe is soft-deleted)
# Prerequisites: Recipe with ID exists but is soft-deleted (deleted_at IS NOT NULL)
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID X not found"
# }
# Note: Soft-deleted recipes are treated as non-existent

###
# Test 23: Refresh normalization - Not Found (Access denied - different user's recipe)
# Prerequisites: Recipe exists but belongs to another user
# Use token from different user account
@otherUserToken = OTHER_USER_JWT_TOKEN_HERE
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{otherUserToken}}

# Expected response (404):
# {
#     "code": "NOT_FOUND",
#     "message": "Recipe with ID X not found"
# }
# Note: Returns 404 (not 403) to prevent information leak about recipe existence (anti-leak)

###
# Test 24: Refresh normalization - Real-world workflow
# Step 1: Check current status (may be READY)
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

###
# Test 24 (continued): Step 2: Trigger refresh
POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

###
# Test 24 (continued): Step 3: Check status immediately after refresh (should be PENDING)
GET {{baseUrl}}/{{testRecipeId}}/normalized-ingredients
Authorization: Bearer {{authToken}}

# Expected flow:
# 1. GET returns status READY (or any other status)
# 2. POST returns 202 with status PENDING
# 3. GET returns status PENDING with empty items and updated_at=null
# 4. (After worker processes the job) GET will return status READY with items

###
# Test 25: Refresh normalization - Verify database state after refresh
# Prerequisites: Recipe with ID @testRecipeId exists
#
# Steps to manually verify:
# 1. Call POST refresh endpoint
# 2. Check database tables:
#    - recipes.normalized_ingredients_status should be 'PENDING'
#    - recipes.normalized_ingredients_updated_at should be NULL
#    - normalized_ingredients_jobs should have one row for this recipe_id with status 'PENDING'
# 3. Call POST refresh again (idempotency test)
# 4. Check database:
#    - normalized_ingredients_jobs should still have ONLY ONE row for this recipe_id
#    - Job updated_at timestamp should be updated to now()
#    - Job attempts counter should be reset to 0

POST {{baseUrl}}/{{testRecipeId}}/normalized-ingredients/refresh
Authorization: Bearer {{authToken}}

# Expected response (202):
# {
#     "recipe_id": 1,
#     "status": "PENDING"
# }

###
