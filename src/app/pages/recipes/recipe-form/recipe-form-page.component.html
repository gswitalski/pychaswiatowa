<pych-page-header
    [title]="pageTitle()">
    <button
        mat-stroked-button
        type="button"
        (click)="onCancel()"
        [disabled]="saving()">
        Anuluj
    </button>
    <button
        mat-flat-button
        color="primary"
        type="button"
        [disabled]="isSaveDisabled()"
        (click)="onSubmit()">
        @if (saving()) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        {{ isEditMode() ? 'Zapisz zmiany' : 'Dodaj przepis' }}
        }
    </button>
</pych-page-header>

<div class="recipe-form-page">
    @if (loading()) {
    <div class="loading-container">
        <mat-spinner diameter="48"></mat-spinner>
        <p>Ładowanie przepisu...</p>
    </div>
    } @else {
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="recipe-form">
        @if (error()) {
        <div class="error-banner">
            <mat-icon>error</mat-icon>
            <span>{{ error() }}</span>
        </div>
        }

        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Podstawowe informacje</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pych-recipe-basic-info-form
                    [nameControl]="form.controls.name"
                    [descriptionControl]="form.controls.description"
                    [servingsControl]="form.controls.servings"
                    [isTermorobotControl]="form.controls.isTermorobot"
                    [isGrillControl]="form.controls.isGrill"
                    [prepTimeMinutesControl]="form.controls.prepTimeMinutes"
                    [totalTimeMinutesControl]="form.controls.totalTimeMinutes"
                    [dietTypeControl]="form.controls.dietType"
                    [cuisineControl]="form.controls.cuisine"
                    [difficultyControl]="form.controls.difficulty" />
            </mat-card-content>
        </mat-card>

        <mat-card class="form-section">
            <mat-card-header>
                <div class="form-section-header">
                    <mat-card-title>Zdjęcie</mat-card-title>
                    @if (isAiImageButtonVisible()) {
                        <button
                            mat-icon-button
                            type="button"
                            class="ai-image-button"
                            [disabled]="isAiImageButtonDisabled()"
                            [matTooltip]="recipeId() ? 'Wygeneruj zdjęcie za pomocą AI' : 'Zapisz przepis, aby wygenerować zdjęcie AI'"
                            (click)="onGenerateAiImage()"
                            aria-label="Wygeneruj zdjęcie za pomocą AI">
                            @if (aiGenerating()) {
                                <mat-spinner diameter="20"></mat-spinner>
                            } @else {
                                <mat-icon>auto_awesome</mat-icon>
                            }
                        </button>
                    }
                </div>
            </mat-card-header>
            <mat-card-content>
                <pych-recipe-image-upload
                    [recipeId]="recipeId()"
                    [currentImageUrl]="currentImageUrl()"
                    [disabled]="saving() || aiGenerating()"
                    (imageEvent)="onImageEvent($event)" />
            </mat-card-content>
        </mat-card>

        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Kategoria, tagi i widoczność</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pych-recipe-categorization-form
                    [categoryControl]="form.controls.categoryId"
                    [tagsArray]="tagsArray"
                    [visibilityControl]="form.controls.visibility"
                    [categories]="categories()" />
            </mat-card-content>
        </mat-card>

        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Składniki</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pych-editable-list
                    [formArray]="ingredientsArray"
                    label="Składnik"
                    placeholder="Dodaj składnik (użyj # na początku dla nagłówka)" />
                @if (ingredientsArray.hasError('minArrayLength') &&
                ingredientsArray.touched) {
                <div class="field-error">
                    <mat-icon>warning</mat-icon>
                    <span>Dodaj co najmniej jeden składnik</span>
                </div>
                }
            </mat-card-content>
        </mat-card>

        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Kroki przygotowania</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pych-editable-list
                    [formArray]="stepsArray"
                    label="Krok"
                    placeholder="Dodaj krok (użyj # na początku dla nagłówka)" />
                @if (stepsArray.hasError('minArrayLength') &&
                stepsArray.touched) {
                <div class="field-error">
                    <mat-icon>warning</mat-icon>
                    <span>Dodaj co najmniej jeden krok</span>
                </div>
                }
            </mat-card-content>
        </mat-card>

        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Wskazówki (opcjonalnie)</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pych-editable-list
                    [formArray]="tipsArray"
                    label="Wskazówka"
                    placeholder="Dodaj wskazówkę (użyj # na początku dla nagłówka)" />
            </mat-card-content>
        </mat-card>
    </form>
    }
</div>
