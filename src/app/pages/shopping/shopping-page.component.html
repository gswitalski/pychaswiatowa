<div class="shopping-page">
    <pych-page-header [title]="'Zakupy'">
        @if (canClear() > 0 && !isLoading()) {
            <button
                mat-icon-button
                [disabled]="isClearing()"
                (click)="onOpenClearDialog()"
                matTooltip="Wyczyść listę"
                aria-label="Wyczyść całą listę zakupów"
            >
                @if (isClearing()) {
                    <mat-spinner [diameter]="24" aria-label="Czyszczenie listy w toku" />
                } @else {
                    <mat-icon>delete_sweep</mat-icon>
                }
            </button>
        }
    </pych-page-header>

    <div class="shopping-page__content">
        <!-- Formularz dodawania pozycji -->
        <div class="shopping-page__add-section">
            <pych-shopping-add-item-form
                [isSubmitting]="isAddingManual()"
                (add)="onAddManualItem($event)"
            />
        </div>

        <!-- Stan: Ładowanie początkowe -->
        @if (isLoading()) {
            <div class="shopping-page__loading" role="status" aria-live="polite">
                <mat-spinner [diameter]="48" aria-label="Ładowanie listy zakupów" />
                <p>Ładowanie listy zakupów...</p>
            </div>
        }
        <!-- Stan: Błąd -->
        @else if (error()) {
            <div class="shopping-page__error">
                <p class="shopping-page__error-message">{{ error()!.message }}</p>
                <button
                    mat-flat-button
                    color="primary"
                    (click)="onRetry()"
                    aria-label="Spróbuj załadować listę ponownie"
                >
                    Spróbuj ponownie
                </button>
            </div>
        }
        <!-- Stan: Pusta lista -->
        @else if (isEmpty()) {
            <pych-empty-state
                [icon]="'shopping_cart'"
                [title]="'Brak pozycji na liście'"
                [description]="'Dodaj pozycje ręcznie lub dodaj przepisy do planu, aby automatycznie wygenerować listę zakupów.'"
            />
        }
        <!-- Stan: Lista z danymi -->
        @else {
            <div class="shopping-page__list-container" [class.shopping-page__list-container--refreshing]="isRefreshing()">
                <pych-shopping-list
                    [items]="groupedItemsSorted()"
                    [toggleInProgressRowIds]="mutationState().togglingRowIds"
                    [deleteInProgressIds]="mutationState().deletingItemIds"
                    (toggleOwned)="onToggleOwned($event)"
                    (deleteManual)="onDeleteManual($event)"
                    (deleteRecipeGroup)="onDeleteRecipeGroup($event)"
                />
            </div>
        }
    </div>
</div>
