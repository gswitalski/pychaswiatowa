<!-- Loading state -->
@if (isLoading()) {
    <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Ładowanie przepisu...</p>
    </div>
}

<!-- Error state -->
@if (error() && !isLoading()) {
    <div class="error-container">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h2 class="error-title">
            @if (error()!.status === 404) {
                Nie znaleziono przepisu
            } @else if (error()!.status === 400) {
                Nieprawidłowy adres
            } @else {
                Wystąpił błąd
            }
        </h2>
        <p class="error-message">{{ error()!.message }}</p>

        <div class="error-actions">
            @if (error()!.status === 404 || error()!.status === 400) {
                <button mat-raised-button color="primary" (click)="onBackToExplore()">
                    <mat-icon>arrow_back</mat-icon>
                    Wróć do przeglądania
                </button>
            } @else {
                <button mat-raised-button color="primary" (click)="onRetry()">
                    <mat-icon>refresh</mat-icon>
                    Spróbuj ponownie
                </button>
                <button mat-stroked-button (click)="onBackToExplore()">
                    Wróć do przeglądania
                </button>
            }
        </div>
    </div>
}

<!-- Success state - recipe content -->
@if (hasRecipe() && !isLoading() && !error()) {
    <div class="recipe-detail-container">
        <!-- Page header with CTA (only for guests) -->
        <pych-page-header [title]="'Przepis'">
            <!-- Akcje dla gościa (niezalogowanego) -->
            @if (headerMode() === 'guest') {
                <div header-actions class="header-cta">
                    <button
                        mat-raised-button
                        color="primary"
                        (click)="onLogin()"
                        aria-label="Zaloguj się, aby zapisać ten przepis"
                    >
                        Zaloguj się
                    </button>
                    <button
                        mat-stroked-button
                        color="primary"
                        (click)="onRegister()"
                        aria-label="Zarejestruj się, aby zapisać przepisy"
                    >
                        Zarejestruj się
                    </button>
                </div>
            }

            <!-- Akcje dla zalogowanego użytkownika - cudzy przepis -->
            @if (headerMode() === 'addToCollection') {
                <div header-actions class="header-actions">
                    <button
                        mat-raised-button
                        color="primary"
                        (click)="onAddToCollection()"
                        matTooltip="Dodaj ten przepis do swojej kolekcji"
                        aria-label="Dodaj do kolekcji"
                    >
                        <mat-icon>bookmark_add</mat-icon>
                        Dodaj do kolekcji
                    </button>
                </div>
            }

            <!-- Akcje dla właściciela przepisu -->
            @if (headerMode() === 'ownerActions') {
                <div header-actions class="header-actions">
                    <button
                        mat-icon-button
                        (click)="onEdit()"
                        matTooltip="Edytuj przepis"
                        aria-label="Edytuj przepis"
                    >
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button
                        mat-icon-button
                        color="warn"
                        (click)="onDelete()"
                        matTooltip="Usuń przepis"
                        aria-label="Usuń przepis"
                    >
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            }

            <button
                mat-icon-button
                back-button
                (click)="onBackToExplore()"
                matTooltip="Wróć do przeglądania"
                aria-label="Wróć do przeglądania przepisów"
            >
                <mat-icon>arrow_back</mat-icon>
            </button>
        </pych-page-header>

        <div class="recipe-content">
            <!-- Wiersz 1: Header - tytuł, opis, kategoria, tagi (lewa) + zdjęcie (prawa) -->
            <div class="recipe-header-section">
                <div class="recipe-info">
                    <pych-recipe-header
                        [recipe]="recipe()!"
                        [isPublic]="true"
                    />
                </div>

                <!-- Recipe image (zawsze wyświetlany, z placeholder gdy brak) -->
                <pych-recipe-image
                    [imageUrl]="recipe()!.image_path"
                    [recipeName]="recipe()!.name"
                />
            </div>

            <!-- Wiersz 2: Składniki (lewa) + kroki przygotowania (prawa) -->
            <div class="recipe-details">
                <pych-recipe-content-list
                    title="Składniki"
                    [content]="recipe()!.ingredients"
                    [isNumbered]="false"
                />

                <pych-recipe-content-list
                    title="Kroki przygotowania"
                    [content]="recipe()!.steps"
                    [isNumbered]="true"
                />
            </div>

            <!-- Recipe metadata footer -->
            <div class="recipe-footer">
                <div class="author-info">
                    <mat-icon>person</mat-icon>
                    <span>Autor: {{ recipe()!.author.username }}</span>
                </div>
                <div class="created-date">
                    <mat-icon>calendar_today</mat-icon>
                    <span>Utworzono: {{ recipe()!.created_at | date: 'dd.MM.yyyy' }}</span>
                </div>
            </div>

            <!-- CTA Section at the bottom (only for guests) -->
            @if (headerMode() === 'guest') {
                <div class="bottom-cta-section">
                    <mat-card class="cta-card">
                        <mat-card-content>
                            <mat-icon class="cta-icon">bookmark_border</mat-icon>
                            <h3>Chcesz zapisać ten przepis?</h3>
                            <p>Zaloguj się lub zarejestruj, aby dodać przepisy do swoich kolekcji!</p>
                            <div class="cta-buttons">
                                <button mat-raised-button color="primary" (click)="onLogin()">
                                    Zaloguj się
                                </button>
                                <button mat-stroked-button color="primary" (click)="onRegister()">
                                    Zarejestruj się
                                </button>
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>
            }
        </div>
    </div>
}
