<!-- Loading state -->
@if (isLoading()) {
    <div class="loading-container">
        <mat-spinner diameter="48"></mat-spinner>
        <p>Ładowanie przepisu...</p>
    </div>
}

<!-- Error state -->
@if (error() && !isLoading()) {
    <div class="error-container">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h2 class="error-title">
            @if (error()!.status === 404) {
                Nie znaleziono przepisu
            } @else if (error()!.status === 403) {
                Brak dostępu
            } @else if (error()!.status === 400) {
                Nieprawidłowy adres
            } @else {
                Wystąpił błąd
            }
        </h2>
        <p class="error-message">{{ error()!.message }}</p>

        <div class="error-actions">
            @if (!isAuthenticated() && showAuthCtaOnError() && error()!.status === 404) {
                <button mat-raised-button color="primary" (click)="onLogin()">
                    <mat-icon>login</mat-icon>
                    Zaloguj się
                </button>
                <button mat-stroked-button (click)="onRegister()">
                    Zarejestruj się
                </button>
            } @else {
                <button mat-raised-button color="primary" (click)="onBack()">
                    <mat-icon>arrow_back</mat-icon>
                    {{ backLabel() }}
                </button>
            }
        </div>
    </div>
}

<!-- Success state - recipe content -->
@if (hasRecipe() && !isLoading() && !error()) {
    <div class="recipe-detail-container">
        @if (showPageHeader() && isAuthenticated()) {
            <pych-page-header
                [title]="pageTitle()"
            >
                @if (headerMode() === 'ownerActions') {
                    <button
                        mat-icon-button
                        matTooltip="Dodaj do kolekcji"
                        aria-label="Dodaj do kolekcji"
                        (click)="onAddToCollection()"
                    >
                        <mat-icon>bookmark_add</mat-icon>
                    </button>
                    @if (!recipe()!.in_my_plan && !isAddingToPlan()) {
                        <button
                            mat-icon-button
                            matTooltip="Dodaj do planu"
                            aria-label="Dodaj do planu"
                            (click)="onAddToPlan()"
                        >
                            <mat-icon>playlist_add</mat-icon>
                        </button>
                    }
                    @if (isAddingToPlan()) {
                        <button
                            mat-icon-button
                            disabled
                            aria-label="Dodawanie do planu..."
                        >
                            <mat-spinner diameter="24"></mat-spinner>
                        </button>
                    }
                    @if (recipe()!.in_my_plan && !isAddingToPlan()) {
                        <button
                            mat-icon-button
                            matTooltip="Zobacz listę"
                            aria-label="Zobacz listę"
                            (click)="onOpenPlan()"
                        >
                            <mat-icon>check_circle</mat-icon>
                        </button>
                    }
                    <button
                        mat-icon-button
                        matTooltip="Edytuj przepis"
                        aria-label="Edytuj przepis"
                        (click)="onEdit()"
                    >
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button
                        mat-icon-button
                        matTooltip="Usuń przepis"
                        aria-label="Usuń przepis"
                        color="warn"
                        (click)="onDelete()"
                    >
                        <mat-icon>delete</mat-icon>
                    </button>
                } @else if (headerMode() === 'addToCollection') {
                    <button
                        mat-raised-button
                        color="primary"
                        (click)="onAddToCollection()"
                        matTooltip="Dodaj ten przepis do swojej kolekcji"
                        aria-label="Dodaj do kolekcji"
                    >
                        <mat-icon>bookmark_add</mat-icon>
                        Dodaj do kolekcji
                    </button>
                    @if (!recipe()!.in_my_plan && !isAddingToPlan()) {
                        <button
                            mat-raised-button
                            (click)="onAddToPlan()"
                            matTooltip="Dodaj przepis do mojego planu"
                            aria-label="Dodaj do planu"
                        >
                            <mat-icon>playlist_add</mat-icon>
                            Dodaj do planu
                        </button>
                    }
                    @if (isAddingToPlan()) {
                        <button
                            mat-raised-button
                            disabled
                            aria-label="Dodawanie do planu..."
                        >
                            <mat-spinner diameter="20"></mat-spinner>
                        </button>
                    }
                    @if (recipe()!.in_my_plan && !isAddingToPlan()) {
                        <button
                            mat-raised-button
                            color="accent"
                            (click)="onOpenPlan()"
                            matTooltip="Otwórz mój plan"
                            aria-label="Otwórz mój plan"
                        >
                            <mat-icon>check_circle</mat-icon>
                            Zobacz listę
                        </button>
                    }
                }
            </pych-page-header>
        }

        <div class="recipe-content">
            <div class="recipe-header-section">
                <div class="recipe-info">
                    <pych-recipe-header
                        [recipe]="recipe()!"
                        [isPublic]="isPublicView()"
                    />
                </div>

                <pych-recipe-image
                    [imageUrl]="recipe()!.image_path"
                    [recipeName]="recipe()!.name ?? ''"
                />
            </div>

            <div class="recipe-details">
                <pych-recipe-content-list
                    title="Składniki"
                    [content]="recipe()!.ingredients"
                    [isNumbered]="false"
                />

                <pych-recipe-content-list
                    title="Kroki przygotowania"
                    [content]="recipe()!.steps"
                    [isNumbered]="true"
                />

                @if (recipe()?.tips && recipe()!.tips.length > 0) {
                    <pych-recipe-content-list
                        title="Wskazówki"
                        [content]="recipe()!.tips"
                        [isNumbered]="false"
                    />
                }
            </div>

            @if (showGuestCta() && headerMode() === 'guest') {
                <div class="bottom-cta-section">
                    <mat-card class="cta-card">
                        <mat-card-content>
                            <mat-icon class="cta-icon">bookmark_border</mat-icon>
                            <h3>Chcesz zapisać ten przepis?</h3>
                            <p>Zaloguj się lub zarejestruj, aby dodać przepisy do swoich kolekcji!</p>
                            <div class="cta-buttons">
                                <button mat-raised-button color="primary" (click)="onLogin()">
                                    Zaloguj się
                                </button>
                                <button mat-stroked-button color="primary" (click)="onRegister()">
                                    Zarejestruj się
                                </button>
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>
            }
        </div>
    </div>
}

