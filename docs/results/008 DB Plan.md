# Schemat Bazy Danych PostgreSQL - PychaŚwiatowa

Dokument ten definiuje strukturę bazy danych dla aplikacji PychaŚwiatowa, zaprojektowaną do działania na platformie Supabase z wykorzystaniem PostgreSQL.

## 1. Lista Tabel

### Tabela: `profiles`
Przechowuje publiczne dane użytkowników, rozszerzając standardową tabelę `auth.users` z Supabase.

| Nazwa kolumny | Typ danych    | Ograniczenia                                                              | Opis                                             |
|---------------|---------------|---------------------------------------------------------------------------|--------------------------------------------------|
| `id`          | `uuid`        | `PRIMARY KEY`, `REFERENCES auth.users(id) ON DELETE CASCADE`              | Klucz główny, powiązany z `auth.users`.            |
| `username`    | `text`        | `CHECK (char_length(username) >= 3 AND char_length(username) <= 50)`      | Nazwa użytkownika.                               |
| `created_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas utworzenia profilu.                           |
| `updated_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas ostatniej aktualizacji profilu.             |

### Tabela: `categories`
Tabela słownikowa przechowująca predefiniowane kategorie przepisów. Dane będą inicjalizowane za pomocą skryptu `seed.sql`.

| Nazwa kolumny | Typ danych    | Ograniczenia                          | Opis                                  |
|---------------|---------------|---------------------------------------|---------------------------------------|
| `id`          | `bigint`      | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unikalny identyfikator kategorii.     |
| `name`        | `text`        | `NOT NULL`, `UNIQUE`                  | Nazwa kategorii (np. "Obiad", "Deser"). |
| `created_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`           | Czas utworzenia rekordu.              |

### Tabela: `recipes`
Główna tabela przechowująca wszystkie przepisy użytkowników.

| Nazwa kolumny | Typ danych    | Ograniczenia                                                              | Opis                                                        |
|---------------|---------------|---------------------------------------------------------------------------|-------------------------------------------------------------|
| `id`          | `bigint`      | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                         | Unikalny identyfikator przepisu.                            |
| `user_id`     | `uuid`        | `NOT NULL`, `REFERENCES auth.users(id)`, `DEFAULT auth.uid()`               | Identyfikator właściciela przepisu.                         |
| `category_id` | `bigint`      | `REFERENCES categories(id)`                                               | Klucz obcy do tabeli `categories`.                          |
| `name`        | `text`        | `NOT NULL`, `CHECK (char_length(name) > 0 AND char_length(name) <= 150)`  | Nazwa przepisu.                                             |
| `description` | `text`        | -                                                                         | Opcjonalny opis przepisu.                                   |
| `image_path`  | `text`        | -                                                                         | Ścieżka do zdjęcia w Supabase Storage.                      |
| `ingredients` | `jsonb`       | `NOT NULL`                                                                | Lista składników w formacie JSON.                           |
| `steps`       | `jsonb`       | `NOT NULL`                                                                | Lista kroków w formacie JSON.                               |
| `created_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas utworzenia przepisu.                                   |
| `updated_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas ostatniej aktualizacji przepisu.                       |
| `deleted_at`  | `timestamptz` | -                                                                         | Czas "miękkiego usunięcia" przepisu.                         |

### Tabela: `tags`
Przechowuje tagi zdefiniowane przez użytkowników.

| Nazwa kolumny | Typ danych    | Ograniczenia                                                              | Opis                               |
|---------------|---------------|---------------------------------------------------------------------------|------------------------------------|
| `id`          | `bigint`      | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                         | Unikalny identyfikator tagu.       |
| `user_id`     | `uuid`        | `NOT NULL`, `REFERENCES auth.users(id)`, `DEFAULT auth.uid()`               | Identyfikator właściciela tagu.    |
| `name`        | `text`        | `NOT NULL`, `CHECK (char_length(name) > 0 AND char_length(name) <= 50)`   | Nazwa tagu.                        |
| `created_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas utworzenia tagu.              |
| -             | -             | `UNIQUE (user_id, lower(name))`                                           | Zapewnia unikalność tagów per użytkownik (case-insensitive). |

### Tabela: `collections`
Przechowuje kolekcje (zbiory przepisów) utworzone przez użytkowników.

| Nazwa kolumny | Typ danych    | Ograniczenia                                                              | Opis                                |
|---------------|---------------|---------------------------------------------------------------------------|-------------------------------------|
| `id`          | `bigint`      | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                         | Unikalny identyfikator kolekcji.    |
| `user_id`     | `uuid`        | `NOT NULL`, `REFERENCES auth.users(id)`, `DEFAULT auth.uid()`               | Identyfikator właściciela kolekcji. |
| `name`        | `text`        | `NOT NULL`, `CHECK (char_length(name) > 0 AND char_length(name) <= 100)`  | Nazwa kolekcji.                     |
| `description` | `text`        | -                                                                         | Opcjonalny opis kolekcji.           |
| `created_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas utworzenia kolekcji.           |
| `updated_at`  | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                               | Czas ostatniej aktualizacji kolekcji.|
| -             | -             | `UNIQUE (user_id, name)`                                                  | Zapewnia unikalność nazw kolekcji per użytkownik. |

### Tabele łączące (Junction Tables)

#### `recipe_tags`
Łączy przepisy z tagami w relacji wiele-do-wielu.

| Nazwa kolumny | Typ danych | Ograniczenia                                                  |
|---------------|------------|---------------------------------------------------------------|
| `recipe_id`   | `bigint`   | `REFERENCES recipes(id) ON DELETE CASCADE`                    |
| `tag_id`      | `bigint`   | `REFERENCES tags(id) ON DELETE CASCADE`                       |
| -             | -          | `PRIMARY KEY (recipe_id, tag_id)`                             |

#### `recipe_collections`
Łączy przepisy z kolekcjami w relacji wiele-do-wielu.

| Nazwa kolumny | Typ danych | Ograniczenia                                                  |
|---------------|------------|---------------------------------------------------------------|
| `recipe_id`   | `bigint`   | `REFERENCES recipes(id) ON DELETE CASCADE`                    |
| `collection_id`| `bigint`   | `REFERENCES collections(id) ON DELETE CASCADE`                |
| -             | -          | `PRIMARY KEY (recipe_id, collection_id)`                      |

## 2. Relacje Między Tabelami

- **`auth.users` <-> `profiles`**: Jeden-do-jednego (1:1)
- **`auth.users` <-> `recipes`**: Jeden-do-wielu (1:N)
- **`auth.users` <-> `tags`**: Jeden-do-wielu (1:N)
- **`auth.users` <-> `collections`**: Jeden-do-wielu (1:N)
- **`categories` <-> `recipes`**: Jeden-do-wielu (1:N)
- **`recipes` <-> `tags`**: Wiele-do-wielu (N:M) poprzez tabelę `recipe_tags`.
- **`recipes` <-> `collections`**: Wiele-do-wielu (N:M) poprzez tabelę `recipe_collections`.

## 3. Indeksy

- **`recipes`**:
  - Indeks B-drzewa na `(user_id)` (automatycznie tworzony dla klucza obcego).
  - Indeks B-drzewa na `(name)` w celu optymalizacji sortowania alfabetycznego.
  - Indeks B-drzewa na `(created_at)` w celu optymalizacji sortowania po dacie.
  - Indeks GIN na wektorze `tsvector` z kolumn `name` i `ingredients` w celu wydajnego wyszukiwania pełnotekstowego.

- **`tags`**:
  - Unikalny indeks B-drzewa na `(user_id, lower(name))` w celu zapewnienia unikalności tagów.

- **`recipe_tags`**:
  - Indeks na `(tag_id)` w celu szybkiego wyszukiwania przepisów po tagu.

- **`collections`**:
  - Unikalny indeks B-drzewa na `(user_id, name)`.

- **`recipe_collections`**:
  - Indeks na `(collection_id)` w celu szybkiego wyszukiwania przepisów w kolekcji.

## 4. Zasady PostgreSQL (Row Level Security)

RLS zostanie włączone dla wszystkich tabel przechowujących dane użytkowników, aby zapewnić, że mają oni dostęp wyłącznie do własnych zasobów.

- **Dla tabel `profiles`, `recipes`, `tags`, `collections`**:
  - `SELECT`: Użytkownik może odczytać wiersz, jeśli `auth.uid() = user_id`. Dla `recipes` dodatkowym warunkiem jest `deleted_at IS NULL`.
  - `INSERT`: Użytkownik może dodać wiersz, jeśli `auth.uid() = user_id`.
  - `UPDATE`: Użytkownik może zaktualizować wiersz, jeśli `auth.uid() = user_id`.
  - `DELETE`: Użytkownik może usunąć wiersz, jeśli `auth.uid() = user_id`.

- **Dla tabel `recipe_tags` i `recipe_collections`**:
  - `SELECT`: Użytkownik może odczytać wiersz, jeśli jest właścicielem powiązanego przepisu.
  - `INSERT`: Użytkownik może dodać wiersz, jeśli jest właścicielem zarówno przepisu, jak i tagu/kolekcji.
  - `DELETE`: Użytkownik może usunąć wiersz, jeśli jest właścicielem powiązanego przepisu.

## 5. Dodatkowe uwagi i decyzje projektowe

1.  **"Miękkie usuwanie" (Soft Delete)**: Tabela `recipes` wykorzystuje kolumnę `deleted_at`. Usunięcie przepisu polega na ustawieniu znacznika czasu w tej kolumnie, a nie na fizycznym usunięciu rekordu. Wszystkie zapytania `SELECT` muszą filtrować `WHERE deleted_at IS NULL`.
2.  **Struktura JSONB**: Kolumny `ingredients` i `steps` będą przechowywać dane w formacie JSON, np.:
    ```json
    [
      { "type": "header", "content": "Nagłówek sekcji" },
      { "type": "item", "content": "Element listy (składnik lub krok)" }
    ]
    ```
3.  **Logika w bazie danych**:
    - **Funkcja do parsowania**: Zostanie utworzona funkcja PostgreSQL, która będzie przyjmować surowy tekst i konwertować go na strukturę JSONB dla `ingredients` i `steps`.
    - **Widok `recipe_details`**: Zostanie utworzony widok, który połączy dane z tabel `recipes`, `categories`, `tags` i `collections`, aby uprościć zapytania po stronie klienta i unikać problemu N+1.
    - **Trigger `updated_at`**: Zostanie utworzony trigger, który automatycznie zaktualizuje kolumnę `updated_at` przy każdej modyfikacji wiersza w tabelach `profiles`, `recipes`, `collections`.
4.  **Supabase Storage**: Zdjęcia będą przechowywane w Supabase Storage. Tabela `recipes` przechowuje jedynie ścieżkę do pliku. Dostęp do bucketów będzie chroniony osobnymi politykami RLS w panelu Supabase.
